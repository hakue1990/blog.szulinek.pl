<!doctype html><html lang=en dir=auto><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=robots content="index, follow"><title>Docker Nextcloud | IT Tech Anytime</title><meta name=keywords content="nextcloud,web,toturial"><meta name=description content="my own NextCloud"><meta name=author content><link rel=canonical href=https://canonical.url/to/page><link crossorigin=anonymous href=/assets/css/stylesheet.cb2ba463b21cd55ccebc7e63bb8cfa6b32887f84b96fdab5a1fa38e91370b35b.css integrity="sha256-yyukY7Ic1VzOvH5ju4z6azKIf4S5b9q1ofo46RNws1s=" rel="preload stylesheet" as=style><script defer crossorigin=anonymous src=/assets/js/highlight.f413e19d0714851f6474e7ee9632408e58ac146fbdbe62747134bea2fa3415e0.js integrity="sha256-9BPhnQcUhR9kdOfuljJAjlisFG+9vmJ0cTS+ovo0FeA=" onload=hljs.initHighlightingOnLoad()></script>
<link rel=icon href=https://szulinek.pl/assets/favicon/favicon.ico><link rel=icon type=image/png sizes=16x16 href=https://szulinek.pl/assets/favicon/favicon-16x16.png><link rel=icon type=image/png sizes=32x32 href=https://szulinek.pl/favicon-32x32.png><link rel=apple-touch-icon href=https://szulinek.pl/assets/favicon/apple-touch-icon.png><link rel=mask-icon href=https://szulinek.pl/safari-pinned-tab.svg><meta name=theme-color content="#2e2e33"><meta name=msapplication-TileColor content="#2e2e33"><link rel=alternate hreflang=en href=https://szulinek.pl/en/posts/docker-nextcloud/><link rel=alternate hreflang=pl href=https://szulinek.pl/pl/posts/docker-nextcloud/><noscript><style>#theme-toggle,.top-link{display:none}</style></noscript><meta property="og:title" content="Docker Nextcloud"><meta property="og:description" content="my own NextCloud"><meta property="og:type" content="article"><meta property="og:url" content="https://szulinek.pl/en/posts/docker-nextcloud/"><meta property="og:image" content="https://szulinek.pl/img/blog/nc.jpg"><meta property="article:section" content="posts"><meta property="article:published_time" content="2023-08-07T17:41:29+02:00"><meta property="article:modified_time" content="2023-08-07T17:41:29+02:00"><meta property="og:site_name" content="IT Tech Anytime"><meta name=twitter:card content="summary_large_image"><meta name=twitter:image content="https://szulinek.pl/img/blog/nc.jpg"><meta name=twitter:title content="Docker Nextcloud"><meta name=twitter:description content="my own NextCloud"><script type=application/ld+json>{"@context":"https://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":4,"name":"Docker Nextcloud","item":"https://szulinek.pl/en/posts/docker-nextcloud/"}]}</script><script type=application/ld+json>{"@context":"https://schema.org","@type":"BlogPosting","headline":"Docker Nextcloud","name":"Docker Nextcloud","description":"my own NextCloud","keywords":["nextcloud","web","toturial"],"articleBody":"What is Nextcloud? Nextcloud is an excellent solution as a self-hosted alternative to Google Drive or Dropbox.\nI’m not going to tell you why you should use Nextcloud. Instead, I will show you how to install a Nextcloud server using Docker containers.\nThis guide utilizes a Nginx reverse proxy configuration, which allows you to deploy your Nextcloud instance with SSL. This way, your Nextcloud deployment’s URL will use the HTTPS protocol, and file transfers will be secure.\nTowards the end of the guide, I will share some tips for Linode cloud users to make deploying Nextcloud easier. Prerequisites\nBefore we proceed, you need to make sure a few things are in order. Here’s what you need:\nA Linux server Docker installed along with Docker Compose A registered domain Deploying Nextcloud Server with Docker on a Reverse Proxy Let’s go through the steps one by one.\nStep 1: Set Up the Reverse Proxy With a reverse proxy, you can deploy multiple web services on the same server. This is necessary because you need a Let’s Encrypt container to handle SSL.\nThere are two methods of configuring an Nginx reverse proxy.\nDeployment of the reverse proxy should be done using a separate Compose file, so you can start or update network services without disrupting the reverse proxy configuration.\nI’ve already prepared the Compose files in our public GitHub repository. Since this isn’t an in-depth article on reverse proxy deployment, I won’t delve into the Compose file details.\nYou can use Git to clone the repo:\ngit clone https://github.com/hakue1990/reverse-proxy-docker \u0026\u0026 \\ cd reverse-proxy-docker There are three files here:\nenv.example: Rename it to .env and change DEFAULT_EMAIL to your email address. max_upload_size.conf: This file ensures you can upload files up to 1 GB in size (default is 2 MB). docker-compose.yaml: The largest of them all, briefly discussed in the next paragraph. Create a Docker network named net. It will be used in the docker-compose.yaml file.\ndocker network create net The docker-compose file looks like this:\nversion: \"3.3\" services: NginxProxy: image: \"jwilder/nginx-proxy:latest\" volumes: - \"NPhtml:/usr/share/nginx/html\" - \"NPdhparam:/etc/nginx/dhparam\" - \"NPvhost:/etc/nginx/vhost.d\" - \"NPcerts:/etc/nginx/certs:ro\" - \"/var/run/docker.sock:/tmp/docker.sock:ro\" - \"./client_max_upload_size.conf:/etc/nginx/conf.d/client_max_upload_size.conf\" labels: - \"com.github.jrcs.letsencrypt_nginx_proxy_companion.nginx_proxy\" restart: \"on-failure\" networks: [\"net\"] ports: - \"80:80\" - \"443:443\" LetsencryptCompanion: image: \"jrcs/letsencrypt-nginx-proxy-companion:latest\" volumes: - \"LCacme:/etc/acme.sh\" - \"NPvhost:/etc/nginx/vhost.d\" - \"NPcerts:/etc/nginx/certs\" - \"NPhtml:/usr/share/nginx/html\" - \"/var/run/docker.sock:/var/run/docker.sock:ro\" environment: - DEFAULT_EMAIL depends_on: [\"NginxProxy\"] restart: \"on-failure\" networks: [\"net\"] volumes: NPhtml: NPdhparam: NPvhost: NPcerts: LCacme: networks: net: external: true Finally, deploy the containers:\ndocker-compose up -d Upon successful deployment, when you visit the server’s IP address where your reverse proxy is hosted, you will see the following message:\nThis is okay - we haven’t deployed any web applications yet.\nStep 2: Deploy NextCloud There are two components: one is the database, and the other is the Nextcloud frontend.\nFor the backend database, any MySQL-based database will work. I’m choosing MariaDB, especially image tag (version) 10.5.9.\nFor Nextcloud, I’ll use version 21.0.0, which is the latest version at the time of writing this article.\nTherefore, the images used are:\nmariadb:10.5.9 nextcloud:21.0.0 If you’re using this tutorial in the future and there’s a newer version of Nextcloud and MariaDB, use them.\nYou can either clone the GitHub repository or simply download the necessary files:\ngit clone https://github.com/hakue1990/nextcloud-docker-compose.git \u0026\u0026 \\ cd nextcloud-docker Then copy the env.example file and rename it to .env, and set the environment variables within it:\ncp env.example .env 1. NCDatabase The NCDatabase service looks like this:\nNCDatabase: image: \"mariadb:10.5.9\" volumes: - \"NCMariaDB:/var/lib/mysql\" environment: - MYSQL_ROOT_PASSWORD - MYSQL_RANDOM_ROOT_PASSWORD - MYSQL_DATABASE - MYSQL_USER - MYSQL_PASSWORD restart: \"on-failure\" networks: [\"common\"] Image: “mariadb:10.5.9” Volumes: NCMariaDB:/var/lib/mysql - for persistent data, a volume named NCMariaDB is used, which is bound to /var/lib/mysql where MariaDB stores its data. Environment - environment variables defined in the .env file. Restart: “on-failure” - the container will be automatically restarted in case its main process fails. Networks: [“common”] - a network between the database container and the frontend service for communication between them. 2. NCFrontend NCFrontend: image: \"nextcloud:21.0.0\" volumes: - \"NCData:/var/www/html\" environment: - LETSENCRYPT_HOST - VIRTUAL_HOST - TRUSTED_PROXIES - OVERWRITEPROTOCOL - MYSQL_DATABASE - MYSQL_USER - MYSQL_PASSWORD - MYSQL_HOST - SMTP_HOST - SMTP_PORT - SMTP_NAME - SMTP_PASSWORD - MAIL_FROM_ADDRESS - NEXTCLOUD_TRUSTED_DOMAINS - NEXTCLOUD_ADMIN_USER - NEXTCLOUD_ADMIN_PASSWORD depends_on: - \"NCDatabase\" networks: [\"net\", \"common\"] Image: nextcloud:21.0.0 Volumes: **NCData:/var /www/html** - to ensure data safety and prevent loss during a simple container restart, data is stored persistently in the NCData volume, mapped to /var/www/html inside the container.\nNetworks: [“net”, “common”] - two networks: net for reverse-proxy, and common for communication between the database and Nextcloud. Environment variables:\nOpen the .env file (the same one you used for MariaDB) in your favorite text editor and start changing the values as the following:\nLETSENCRYPT_HOST, VIRTUAL_HOST, and NEXTCLOUD_TRUSTED_DOMAINS: Set these to the domain/subdomain you want to host your Nextcloud instance on.\nTRUSTED_PROXIES: The subnet of the network, shared by the reverse proxy and this frontend. You can get the subnet using the following command (make sure jq is installed):\ndocker inspect -f '{{ json .IPAM.Config }}' net | jq -r .[].Subnet OVERWRITEPROTOCOL: The overwriteprotocol parameter is used to set the protocol of the proxy. As we’re using HTTPS, set this to HTTPS.\nVolumes In this network, two internal volumes are defined: NCMariaDB for MariaDB and NCData for Nextcloud. Whether you want to keep them internal or external is up to you.\nvolumes: NCMariaDB: external: true NCData: external: true Then create the volumes:\nfor volume in NCMariaDB NCData; do docker volume create ${volume} done Networks Two networks are defined. One is for the frontend and reverse proxy, and the other one is for the frontend and backend to be able to communicate.\nThe database container and Nextcloud frontend share a common network named “common,” enabling communication between the two containers. You can make this internal, which would limit the database container’s access to the public internet, but I’m not sure of the advantages you might gain from this.\nNevertheless, if you want to do this, it should look like this:\nnetworks: net: external: true common: internal: true Deploy Nextcloud docker-compose up -d If everything goes as planned, you will see your NextCloud application in a Docker container:\nThis concludes your Nextcloud deployment.\n","wordCount":"1019","inLanguage":"en","image":"https://szulinek.pl/img/blog/nc.jpg","datePublished":"2023-08-07T17:41:29+02:00","dateModified":"2023-08-07T17:41:29+02:00","mainEntityOfPage":{"@type":"WebPage","@id":"https://szulinek.pl/en/posts/docker-nextcloud/"},"publisher":{"@type":"Organization","name":"IT Tech Anytime","logo":{"@type":"ImageObject","url":"https://szulinek.pl/assets/favicon/favicon.ico"}}}</script></head><body class=dark id=top><script>localStorage.getItem("pref-theme")==="light"&&document.body.classList.remove("dark")</script><header class=header><nav class=nav><div class=logo><a href=https://szulinek.pl/en/ accesskey=h title="Szulinek.pl (Alt + H)"><img src=https://szulinek.pl/img/coding.png alt aria-label=logo height=35>Szulinek.pl</a><div class=logo-switches><button id=theme-toggle accesskey=t title="(Alt + T)"><svg id="moon" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z"/></svg><svg id="sun" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg></button><ul class=lang-switch><li>|</li><li><a href=https://szulinek.pl/pl/ title=Polski aria-label=:pl:>Pl</a></li></ul></div></div><ul id=menu><li><a href=https://szulinek.pl/en/about title=About><span>About</span></a></li><li><a href=https://szulinek.pl/en/services/ title=Services><span>Services</span></a></li><li><a href=https://szulinek.pl/en/posts/ title=Blog><span>Blog</span></a></li><li><a href=https://szulinek.pl/en/archives/ title=Archives><span>Archives</span></a></li><li><a href=https://szulinek.pl/en/contact/ title=Contact><span>Contact</span></a></li></ul></nav></header><main class=main><article class=post-single><header class=post-header><div class=breadcrumbs><a href=https://szulinek.pl/en/>Home</a></div><h1 class=post-title>Docker Nextcloud</h1><div class=post-description>my own NextCloud</div><div class=post-meta><span title='2023-08-07 17:41:29 +0200 CEST'>August 7, 2023</span>&nbsp;·&nbsp;5 min&nbsp;·&nbsp;1019 words&nbsp;|&nbsp;Translations:<ul class=i18n_list><li><a href=https://szulinek.pl/pl/posts/docker-nextcloud/>Pl</a></li></ul></div></header><figure class=entry-cover><img loading=lazy src=https://szulinek.pl/img/blog/nc.jpg alt=nextcloud></figure><div class=toc><details><summary accesskey=c title="(Alt + C)"><span class=details>Table of Contents</span></summary><div class=inner><nav id=TableOfContents><ul><li><a href=#what-is-nextcloud>What is Nextcloud?</a></li><li><a href=#deploying-nextcloud-server-with-docker-on-a-reverse-proxy>Deploying Nextcloud Server with Docker on a Reverse Proxy</a><ul><li><a href=#step-1-set-up-the-reverse-proxy>Step 1: Set Up the Reverse Proxy</a></li><li><a href=#step-2-deploy-nextcloud>Step 2: Deploy NextCloud</a></li><li><a href=#volumes>Volumes</a></li><li><a href=#networks>Networks</a></li><li><a href=#deploy-nextcloud>Deploy Nextcloud</a></li></ul></li></ul></nav></div></details></div><div class=post-content><h2 id=what-is-nextcloud>What is Nextcloud?<a hidden class=anchor aria-hidden=true href=#what-is-nextcloud>#</a></h2><p>Nextcloud is an excellent solution as a self-hosted alternative to <strong>Google Drive</strong> or <strong>Dropbox</strong>.</p><p>I&rsquo;m not going to tell you why you should use Nextcloud. Instead, I will show you how to install a Nextcloud server using Docker containers.</p><p>This guide utilizes a Nginx reverse proxy configuration, which allows you to deploy your Nextcloud instance with SSL. This way, your Nextcloud deployment&rsquo;s URL will use the HTTPS protocol, and file transfers will be secure.</p><p>Towards the end of the guide, I will share some tips for Linode cloud users to make deploying Nextcloud easier.
Prerequisites</p><p>Before we proceed, you need to make sure a few things are in order. Here&rsquo;s what you need:</p><ul><li>A Linux server</li><li>Docker installed along with Docker Compose</li><li>A registered domain</li></ul><h2 id=deploying-nextcloud-server-with-docker-on-a-reverse-proxy>Deploying Nextcloud Server with Docker on a Reverse Proxy<a hidden class=anchor aria-hidden=true href=#deploying-nextcloud-server-with-docker-on-a-reverse-proxy>#</a></h2><p>Let&rsquo;s go through the steps one by one.</p><h3 id=step-1-set-up-the-reverse-proxy>Step 1: Set Up the Reverse Proxy<a hidden class=anchor aria-hidden=true href=#step-1-set-up-the-reverse-proxy>#</a></h3><p>With a reverse proxy, you can deploy multiple web services on the same server. This is necessary because you need a <strong>Let&rsquo;s Encrypt</strong> container to handle <strong>SSL</strong>.</p><p>There are two methods of configuring an Nginx reverse proxy.</p><p>Deployment of the reverse proxy should be done using a separate Compose file, so you can start or update network services without disrupting the reverse proxy configuration.</p><p>I&rsquo;ve already prepared the Compose files in our public GitHub repository. Since this isn&rsquo;t an in-depth article on reverse proxy deployment, I won&rsquo;t delve into the Compose file details.</p><p>You can use Git to clone the repo:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>git clone https://github.com/hakue1990/reverse-proxy-docker <span class=o>&amp;&amp;</span> <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>	<span class=nb>cd</span> reverse-proxy-docker
</span></span></code></pre></div><p>There are three files here:</p><ul><li><strong>env.example:</strong> Rename it to .env and change DEFAULT_EMAIL to your <strong>email address</strong>.</li><li><strong>max_upload_size.conf:</strong> This file ensures you can upload files up to 1 GB in size (default is 2 MB).</li><li><strong>docker-compose.yaml:</strong> The largest of them all, briefly discussed in the next paragraph.</li></ul><p>Create a Docker network named <strong>net</strong>. It will be used in the <strong>docker-compose.yaml</strong> file.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>docker network create net
</span></span></code></pre></div><p>The docker-compose file looks like this:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl><span class=nt>version</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;3.3&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>services</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>NginxProxy</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>image</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;jwilder/nginx-proxy:latest&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>volumes</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span>- <span class=s2>&#34;NPhtml:/usr/share/nginx/html&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span>- <span class=s2>&#34;NPdhparam:/etc/nginx/dhparam&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span>- <span class=s2>&#34;NPvhost:/etc/nginx/vhost.d&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span>- <span class=s2>&#34;NPcerts:/etc/nginx/certs:ro&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span>- <span class=s2>&#34;/var/run/docker.sock:/tmp/docker.sock:ro&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span>- <span class=s2>&#34;./client_max_upload_size.conf:/etc/nginx/conf.d/client_max_upload_size.conf&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>labels</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span>- <span class=s2>&#34;com.github.jrcs.letsencrypt_nginx_proxy_companion.nginx_proxy&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>restart</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;on-failure&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>networks</span><span class=p>:</span><span class=w> </span><span class=p>[</span><span class=s2>&#34;net&#34;</span><span class=p>]</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>ports</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span>- <span class=s2>&#34;80:80&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span>- <span class=s2>&#34;443:443&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>LetsencryptCompanion</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>image</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;jrcs/letsencrypt-nginx-proxy-companion:latest&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>volumes</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span>- <span class=s2>&#34;LCacme:/etc/acme.sh&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span>- <span class=s2>&#34;NPvhost:/etc/nginx/vhost.d&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span>- <span class=s2>&#34;NPcerts:/etc/nginx/certs&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span>- <span class=s2>&#34;NPhtml:/usr/share/nginx/html&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span>- <span class=s2>&#34;/var/run/docker.sock:/var/run/docker.sock:ro&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>environment</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span>- <span class=l>DEFAULT_EMAIL</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>depends_on</span><span class=p>:</span><span class=w> </span><span class=p>[</span><span class=s2>&#34;NginxProxy&#34;</span><span class=p>]</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>restart</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;on-failure&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>networks</span><span class=p>:</span><span class=w> </span><span class=p>[</span><span class=s2>&#34;net&#34;</span><span class=p>]</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>volumes</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>NPhtml</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>NPdhparam</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>NPvhost</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>NPcerts</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>LCacme</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>networks</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>net</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>external</span><span class=p>:</span><span class=w> </span><span class=kc>true</span><span class=w>
</span></span></span></code></pre></div><p>Finally, deploy the <strong>containers</strong>:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>docker-compose up -d
</span></span></code></pre></div><p>Upon successful deployment, when you visit the server&rsquo;s IP address where your reverse proxy is hosted, you will see the following message:</p><p><img loading=lazy src=/img/blog/503-nextcloud-reverse-proxy.webp alt=reverse-proxy title="Nextcloud reverse_proxy"></p><p>This is okay - we haven&rsquo;t deployed any web applications yet.</p><h3 id=step-2-deploy-nextcloud>Step 2: Deploy NextCloud<a hidden class=anchor aria-hidden=true href=#step-2-deploy-nextcloud>#</a></h3><p>There are two components: one is the database, and the other is the Nextcloud frontend.</p><p>For the backend database, any MySQL-based database will work. I&rsquo;m choosing MariaDB, especially image tag (version) 10.5.9.</p><p>For Nextcloud, I&rsquo;ll use version 21.0.0, which is the latest version at the time of writing this article.</p><p>Therefore, the images used are:</p><pre tabindex=0><code>mariadb:10.5.9
nextcloud:21.0.0
</code></pre><p>If you&rsquo;re using this tutorial in the future and there&rsquo;s a newer version of Nextcloud and MariaDB, use them.</p><p>You can either clone the GitHub repository or simply download the necessary files:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>git clone https://github.com/hakue1990/nextcloud-docker-compose.git <span class=o>&amp;&amp;</span> <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span><span class=nb>cd</span> nextcloud-docker
</span></span></code></pre></div><p>Then copy the <code>env.example</code> file and rename it to <code>.env</code>, and set the environment variables within it:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>cp env.example .env
</span></span></code></pre></div><h4 id=1-ncdatabase>1. NCDatabase<a hidden class=anchor aria-hidden=true href=#1-ncdatabase>#</a></h4><p>The NCDatabase service looks like this:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>NCDatabase:
</span></span><span class=line><span class=cl>	image: <span class=s2>&#34;mariadb:10.5.9&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	volumes:
</span></span><span class=line><span class=cl>		- <span class=s2>&#34;NCMariaDB:/var/lib/mysql&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	environment:
</span></span><span class=line><span class=cl>		- MYSQL_ROOT_PASSWORD
</span></span><span class=line><span class=cl>		- MYSQL_RANDOM_ROOT_PASSWORD
</span></span><span class=line><span class=cl>		- MYSQL_DATABASE
</span></span><span class=line><span class=cl>		- MYSQL_USER
</span></span><span class=line><span class=cl>		- MYSQL_PASSWORD
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	restart: <span class=s2>&#34;on-failure&#34;</span>
</span></span><span class=line><span class=cl>	networks: <span class=o>[</span><span class=s2>&#34;common&#34;</span><span class=o>]</span>
</span></span></code></pre></div><ul><li>Image: <strong>&ldquo;mariadb:10.5.9&rdquo;</strong></li><li>Volumes: <strong>NCMariaDB:/var/lib/mysql</strong> - for persistent data, a volume named NCMariaDB is used, which is bound to /var/lib/mysql where MariaDB stores its data.</li><li>Environment - environment variables defined in the .env file.</li><li>Restart: &ldquo;on-failure&rdquo; - the container will be automatically restarted in case its main process fails.</li><li>Networks: [&ldquo;common&rdquo;] - a network between the database container and the frontend service for communication between them.</li></ul><h4 id=2-ncfrontend>2. NCFrontend<a hidden class=anchor aria-hidden=true href=#2-ncfrontend>#</a></h4><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>NCFrontend:
</span></span><span class=line><span class=cl>	image: <span class=s2>&#34;nextcloud:21.0.0&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	volumes: 
</span></span><span class=line><span class=cl>	  - <span class=s2>&#34;NCData:/var/www/html&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	environment:
</span></span><span class=line><span class=cl>		- LETSENCRYPT_HOST
</span></span><span class=line><span class=cl>		- VIRTUAL_HOST
</span></span><span class=line><span class=cl>		- TRUSTED_PROXIES
</span></span><span class=line><span class=cl>		- OVERWRITEPROTOCOL
</span></span><span class=line><span class=cl>		- MYSQL_DATABASE
</span></span><span class=line><span class=cl>		- MYSQL_USER
</span></span><span class=line><span class=cl>		- MYSQL_PASSWORD
</span></span><span class=line><span class=cl>		- MYSQL_HOST
</span></span><span class=line><span class=cl>		- SMTP_HOST
</span></span><span class=line><span class=cl>		- SMTP_PORT
</span></span><span class=line><span class=cl>		- SMTP_NAME
</span></span><span class=line><span class=cl>		- SMTP_PASSWORD
</span></span><span class=line><span class=cl>		- MAIL_FROM_ADDRESS
</span></span><span class=line><span class=cl>		- NEXTCLOUD_TRUSTED_DOMAINS
</span></span><span class=line><span class=cl>		- NEXTCLOUD_ADMIN_USER
</span></span><span class=line><span class=cl>		- NEXTCLOUD_ADMIN_PASSWORD
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	depends_on:
</span></span><span class=line><span class=cl>		- <span class=s2>&#34;NCDatabase&#34;</span>
</span></span><span class=line><span class=cl>	networks: <span class=o>[</span><span class=s2>&#34;net&#34;</span>, <span class=s2>&#34;common&#34;</span><span class=o>]</span>
</span></span></code></pre></div><ul><li>Image: <strong>nextcloud:21.0.0</strong></li><li>Volumes: **NCData:/var</li></ul><p>/www/html** - to ensure data safety and prevent loss during a simple container restart, data is stored persistently in the NCData volume, mapped to /var/www/html inside the container.</p><ul><li>Networks: [&ldquo;net&rdquo;, &ldquo;common&rdquo;] - two networks: net for reverse-proxy, and common for communication between the database and Nextcloud.</li></ul><p><strong>Environment variables:</strong></p><p>Open the .env file (the same one you used for MariaDB) in your favorite text editor and start changing the values as the following:</p><p><strong>LETSENCRYPT_HOST</strong>, <strong>VIRTUAL_HOST</strong>, and <strong>NEXTCLOUD_TRUSTED_DOMAINS</strong>: Set these to the domain/subdomain you want to host your Nextcloud instance on.</p><p><strong>TRUSTED_PROXIES</strong>: The subnet of the network, shared by the reverse proxy and this frontend. You can get the subnet using the following command (make sure jq is installed):</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>docker inspect -f <span class=s1>&#39;{{ json .IPAM.Config }}&#39;</span> net <span class=p>|</span> jq -r .<span class=o>[]</span>.Subnet
</span></span></code></pre></div><p><strong>OVERWRITEPROTOCOL</strong>: The overwriteprotocol parameter is used to set the protocol of the proxy. As we&rsquo;re using HTTPS, set this to HTTPS.</p><h3 id=volumes>Volumes<a hidden class=anchor aria-hidden=true href=#volumes>#</a></h3><p>In this network, two internal volumes are defined: NCMariaDB for MariaDB and NCData for Nextcloud. Whether you want to keep them internal or external is up to you.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>volumes:
</span></span><span class=line><span class=cl>  NCMariaDB:
</span></span><span class=line><span class=cl>    external: <span class=nb>true</span>
</span></span><span class=line><span class=cl>  NCData:
</span></span><span class=line><span class=cl>    external: <span class=nb>true</span>
</span></span></code></pre></div><p>Then create the volumes:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl><span class=k>for</span> volume in NCMariaDB NCData<span class=p>;</span> <span class=k>do</span>
</span></span><span class=line><span class=cl>  docker volume create <span class=si>${</span><span class=nv>volume</span><span class=si>}</span>
</span></span><span class=line><span class=cl><span class=k>done</span>
</span></span></code></pre></div><h3 id=networks>Networks<a hidden class=anchor aria-hidden=true href=#networks>#</a></h3><p>Two networks are defined. One is for the frontend and reverse proxy, and the other one is for the frontend and backend to be able to communicate.</p><p>The database container and Nextcloud frontend share a common network named &ldquo;common,&rdquo; enabling communication between the two containers. You can make this internal, which would limit the database container&rsquo;s access to the public internet, but I&rsquo;m not sure of the advantages you might gain from this.</p><p>Nevertheless, if you want to do this, it should look like this:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>networks:
</span></span><span class=line><span class=cl>	net:
</span></span><span class=line><span class=cl>	    external: <span class=nb>true</span>
</span></span><span class=line><span class=cl>	common:
</span></span><span class=line><span class=cl>		internal: <span class=nb>true</span>
</span></span></code></pre></div><h3 id=deploy-nextcloud>Deploy Nextcloud<a hidden class=anchor aria-hidden=true href=#deploy-nextcloud>#</a></h3><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>docker-compose up -d
</span></span></code></pre></div><p>If everything goes as planned, you will see your NextCloud application in a Docker container:</p><p><img loading=lazy src=/img/blog/nc.png alt=Nextcloud title=Nextcloud></p><p>This concludes your Nextcloud deployment.</p></div><footer class=post-footer><ul class=post-tags><li><a href=https://szulinek.pl/en/tags/nextcloud/>nextcloud</a></li><li><a href=https://szulinek.pl/en/tags/web/>web</a></li><li><a href=https://szulinek.pl/en/tags/toturial/>toturial</a></li></ul><nav class=paginav><a class=next href=https://szulinek.pl/en/posts/mysql-cheatsheet/><span class=title>Next »</span><br><span>MySql Cheatsheet</span></a></nav></footer></article></main><footer class=footer><span>&copy; 2023 <a href=https://szulinek.pl/en/>IT Tech Anytime</a></span>
<span>Powered by
<a href=https://szulinek.pl rel="noopener noreferrer" target=_blank>szulinek.pl</a></span></footer><a href=#top aria-label="go to top" title="Go to Top (Alt + G)" class=top-link id=top-link accesskey=g><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 12 6" fill="currentcolor"><path d="M12 6H0l6-6z"/></svg></a><script>let menu=document.getElementById("menu");menu&&(menu.scrollLeft=localStorage.getItem("menu-scroll-position"),menu.onscroll=function(){localStorage.setItem("menu-scroll-position",menu.scrollLeft)}),document.querySelectorAll('a[href^="#"]').forEach(e=>{e.addEventListener("click",function(e){e.preventDefault();var t=this.getAttribute("href").substr(1);window.matchMedia("(prefers-reduced-motion: reduce)").matches?document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView():document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView({behavior:"smooth"}),t==="top"?history.replaceState(null,null," "):history.pushState(null,null,`#${t}`)})})</script><script>var mybutton=document.getElementById("top-link");window.onscroll=function(){document.body.scrollTop>800||document.documentElement.scrollTop>800?(mybutton.style.visibility="visible",mybutton.style.opacity="1"):(mybutton.style.visibility="hidden",mybutton.style.opacity="0")}</script><script>document.getElementById("theme-toggle").addEventListener("click",()=>{document.body.className.includes("dark")?(document.body.classList.remove("dark"),localStorage.setItem("pref-theme","light")):(document.body.classList.add("dark"),localStorage.setItem("pref-theme","dark"))})</script><script>document.querySelectorAll("pre > code").forEach(e=>{const n=e.parentNode.parentNode,t=document.createElement("button");t.classList.add("copy-code"),t.innerHTML="copy";function s(){t.innerHTML="copied!",setTimeout(()=>{t.innerHTML="copy"},2e3)}t.addEventListener("click",t=>{if("clipboard"in navigator){navigator.clipboard.writeText(e.textContent),s();return}const n=document.createRange();n.selectNodeContents(e);const o=window.getSelection();o.removeAllRanges(),o.addRange(n);try{document.execCommand("copy"),s()}catch{}o.removeRange(n)}),n.classList.contains("highlight")?n.appendChild(t):n.parentNode.firstChild==n||(e.parentNode.parentNode.parentNode.parentNode.parentNode.nodeName=="TABLE"?e.parentNode.parentNode.parentNode.parentNode.parentNode.appendChild(t):e.parentNode.appendChild(t))})</script><script src=/js/custom.js></script></body></html>